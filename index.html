<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pokémon Pack Opening Simulator — Hosted (Weighted, Worker Proxy)</title>
<style>
  :root{
    --bg:#040406; --panel:#071124; --accent:#ffd43b; --text:#e6f0ff;
    --card-w:210px; --card-h:294px;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    background:
      radial-gradient(circle at 10% 10%, rgba(255,212,59,0.03), transparent 8%),
      linear-gradient(180deg,#000 0%, #071124 60%);
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }

  .app{
    width:1000px;
    max-width:96vw;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:12px;
    padding:18px;
    box-shadow:0 10px 40px rgba(2,8,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:20px;margin:0;color:var(--accent);font-weight:800;text-shadow:0 6px 18px rgba(255,180,60,0.08)}
  .controls{display:flex;gap:12px;align-items:center}
  .coins{background:linear-gradient(90deg,#1b3b50,#0d2736);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center}
  button, select {background:linear-gradient(180deg,#ffd43b,#ffb400); color:#081225; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800}
  button:disabled{opacity:0.6;cursor:default}
  .main{display:flex;gap:18px}
  .left{flex:1;display:flex;flex-direction:column;gap:12px}
  .panel{background:linear-gradient(180deg,#071a2a,#071a2a);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.02)}
  .pack-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px}
  .pack-title{font-weight:800}
  .pack-art{height:90px;width:220px;border-radius:10px;background:linear-gradient(135deg,#07243a,#0b2f4a);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.06);font-weight:900;font-size:36px;overflow:hidden}
  .cards-stage{height:340px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px;display:flex;align-items:center;justify-content:flex-start;padding:18px;overflow-x:auto;gap:14px}
  .revealed-card{width:var(--card-w);height:var(--card-h);border-radius:12px;background:#000;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;position:relative;transform-style:preserve-3d;flex:0 0 auto;box-shadow:0 10px 30px rgba(0,0,0,0.45);overflow:hidden}
  .revealed-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;padding:0;transform-origin:center;transition:transform 640ms cubic-bezier(.2,.9,.2,1);transform-style:preserve-3d;border-radius:12px;overflow:hidden;transform:rotateY(-180deg)}
  .revealed-front,.revealed-back{position:absolute;inset:0;display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;backface-visibility:hidden}
  .revealed-front{transform:rotateY(0deg)}
  .revealed-back{transform:rotateY(180deg);background:linear-gradient(135deg,#0b1822,#072032);padding:12px}
  .revealed-card.flipped .revealed-inner{transform:rotateY(0deg)}
  .card-image{width:100%;height:100%;object-fit:cover;display:block}
  .rarity-strip{position:absolute;left:10px;bottom:10px;padding:6px 10px;border-radius:8px;font-weight:800;font-size:13px;background:rgba(0,0,0,0.6);color:var(--accent)}
  .rar-common{border:2px solid rgba(255,255,255,0.06)}
  .rar-uncommon{box-shadow:0 0 18px rgba(56,201,69,0.12);border:2px solid rgba(56,201,69,0.16)}
  .rar-rare{box-shadow:0 0 20px rgba(255,215,120,0.18);border:2px solid rgba(255,215,120,0.20)}
  .rar-ultra{box-shadow:0 0 30px rgba(255,240,180,0.22);border:2px solid rgba(255,240,180,0.22)}
  .rar-secret{box-shadow:0 0 38px rgba(255,230,160,0.26);border:2px solid rgba(255,230,160,0.30)}
  .foil-overlay{position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;background:linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.25) 40%, rgba(255,255,255,0.0) 60%);opacity:0}
  .with-foil .foil-overlay{opacity:0.85;background-size:200% 100%}
  @keyframes shine {0%{background-position:-100% 0%}100%{background-position:200% 0%}}
  .foil-animate{animation:shine 1.6s linear infinite}
  .collection{width:320px}
  .collection .col-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .collection-grid{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto}
  .col-card{display:flex;gap:10px;align-items:center;background:linear-gradient(180deg,#0b2b36,#072033);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
  .col-thumb{width:56px;height:78px;border-radius:6px;overflow:hidden;background:#00121a}
  .muted{opacity:0.75;font-size:13px}
  footer{margin-top:12px;font-size:13px;color:rgba(255,255,255,0.6)}
  .loading{font-size:13px;color:#ffd43b;margin-left:8px}
  .cardIn{animation:cardIn 540ms cubic-bezier(.2,.9,.2,1) both}
  @keyframes cardIn{from{transform:translateY(24px) scale(.96) rotate(-6deg);opacity:0}to{transform:translateY(0) scale(1) rotate(0);opacity:1}}
  /* top-left status */
  #statusBox{position:fixed;left:18px;top:18px;padding:8px 12px;border-radius:8px;background:rgba(6,10,16,0.6);color:#fff;font-weight:700;backdrop-filter: blur(6px);transition:opacity .36s, transform .36s}
  #statusBox.yellow{background:linear-gradient(90deg,#234 0%, #123 100%);border:1px solid rgba(255,212,59,0.08);color: #ffd43b}
  #statusBox.green{background:linear-gradient(90deg,#123 0%, #062 100%);border:1px solid rgba(120,255,150,0.06);color:#c8ffd8}
  #statusBox.red{background:linear-gradient(90deg,#420 0%, #220 100%);border:1px solid rgba(255,100,100,0.06);color:#ffd1d1}
  @media (max-width:720px){ #statusBox{left:10px;top:10px;font-size:13px;padding:6px 8px} }
</style>
</head>
<body>
  <!-- top-left status -->
  <div id="statusBox" class="yellow">Loading Base Set cards...</div>

  <div class="app" role="application" aria-label="Pokemon Pack Opening Simulator">
    <header>
      <h1>Pokémon Pack Opening Simulator</h1>
      <div class="controls">
        <div class="coins" title="Coins"><strong id="coins">500</strong><span style="opacity:.8;margin-left:6px">coins</span></div>
        <select id="packSelect" aria-label="Choose pack"><option value="base1">Base Set (base1)</option></select>
        <button id="openPackBtn" disabled>Open Pack (100)</button>
        <button id="resetBtn">Reset</button>
      </div>
    </header>

    <div class="main">
      <div class="left panel">
        <div class="pack-header">
          <div>
            <div id="packTitle" class="pack-title">Base Set — Live</div>
            <div id="packDesc" class="muted">Real Base Set cards via API • 5 cards • 100 coins</div>
          </div>
          <div class="pack-art" id="packArt">BASE</div>
        </div>

        <div class="cards-stage panel" id="cardsStage" aria-live="polite" aria-atomic="true">
          <div id="stageHint" style="opacity:.06;font-weight:900;font-size:64px">POKÉ</div>
        </div>

        <div style="margin-top:12px" class="muted">Pack composition: 3 commons • 1 uncommon • 1 rare/holo</div>
      </div>

      <aside class="collection panel">
        <div class="col-header"><strong>Collection</strong><div class="muted" style="font-size:13px">— saved in localStorage</div></div>
        <div id="collectionGrid" class="collection-grid" role="region" aria-label="Collection"></div>
      </aside>
    </div>

    <footer>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>Hosted mode — using your Cloudflare Worker proxy for API calls.</div>
        <div class="muted">Prototype — weighted packs</div>
      </div>
    </footer>
  </div>

<script>
/*
  Final host-ready single-file HTML
  - Uses Cloudflare Worker proxy (your URL below) to fetch Base Set
  - Weighted 5-card pack: 3 common, 1 uncommon, 1 rare-or-better
  - Plays a synthesized digital whoosh (WebAudio) AFTER loading text finishes, then flips cards
  - Coins & collection persisted in localStorage
  - Clean top-left status, no console logs shown to players
*/

/* ---------------- CONFIG ---------------- */
const STARTING_COINS = 500;
const PACK_COST = 100;
const CARDS_PER_PACK = 5;
const COIN_KEY = 'pps_final_coins';
const COLLECTION_KEY = 'pps_final_collection';

// Your Cloudflare Worker proxy URL (provided by you)
const WORKER_PROXY = 'https://gentle-lake-18f4.gavin-m-graefnitz.workers.dev/?url=';

// Base Set API endpoint (will be passed through worker)
const API_ENDPOINT = 'https://api.pokemontcg.io/v2/cards?q=set.id:base1&pageSize=250';
const FETCH_URL = WORKER_PROXY + encodeURIComponent(API_ENDPOINT);

// Rarity bucket names used in UI classes
const RARITY_UI = { common:'rar-common', uncommon:'rar-uncommon', rare:'rar-rare', ultra:'rar-ultra', secret:'rar-secret' };

/* ---------------- DOM ---------------- */
const statusBox = document.getElementById('statusBox');
const openBtn = document.getElementById('openPackBtn');
const resetBtn = document.getElementById('resetBtn');
const cardsStage = document.getElementById('cardsStage');
const collectionGrid = document.getElementById('collectionGrid');
const coinsEl = document.getElementById('coins');

/* ---------------- STATE ---------------- */
let coins = parseInt(localStorage.getItem(COIN_KEY) || STARTING_COINS);
let collection = JSON.parse(localStorage.getItem(COLLECTION_KEY) || '{}');
coinsEl.textContent = coins;
let loaded = false;
let cardsByRarity = { common:[], uncommon:[], rare:[], ultra:[], secret:[] };

/* fallback small card back (embedded) */
const CARD_BACK_DATAURI = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='750' height='1050' viewBox='0 0 750 1050'><rect width='750' height='1050' fill='#071124'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#ffd43b' font-family='Arial' font-size='40'>Pokémon Card</text></svg>`);

/* ---------------- UTIL ---------------- */
function saveState(){ localStorage.setItem(COIN_KEY, coins); localStorage.setItem(COLLECTION_KEY, JSON.stringify(collection)); coinsEl.textContent = coins; }
function setStatus(text, variant='yellow'){ statusBox.textContent = text; statusBox.className = variant; }

/* gentle classification of API rarity to buckets */
function classifyRarity(apiRarity, card){
  if (!apiRarity) return 'common';
  const r = String(apiRarity).toLowerCase();
  if (r.includes('secret') || r.includes('rainbow') || r.includes('gold')) return 'secret';
  if (r.includes('holo') || r.includes('foil') || r.includes('holofoil')) return 'ultra';
  if (r === 'rare' || r.includes('rare')) return 'rare';
  if (r.includes('uncommon')) return 'uncommon';
  if (r.includes('common')) return 'common';
  if (card && card.subtypes){
    const sub = card.subtypes.join(' ').toLowerCase();
    if (sub.includes('ex') || sub.includes('gx') || sub.includes('v')) return 'ultra';
  }
  return 'common';
}

/* fetch via your worker with up to n retries */
async function fetchWithRetries(url, attempts = 3){
  setStatus('Loading Base Set cards...', 'yellow');
  for (let i=0;i<attempts;i++){
    try {
      const res = await fetch(url); // worker handles API key header
      if (!res.ok) throw new Error('bad');
      const json = await res.json();
      return json;
    } catch (e) {
      await new Promise(r=>setTimeout(r, 600 + i*300));
    }
  }
  return null;
}

/* load cards and bucket them */
async function loadBaseSet(){
  const data = await fetchWithRetries(FETCH_URL, 3);
  if (!data || !data.data || !Array.isArray(data.data) || data.data.length === 0){
    loaded = false;
    setStatus('Failed to load Base Set cards. Check connection or API key.', 'red');
    openBtn.disabled = true;
    return false;
  }

  // clear buckets
  cardsByRarity = { common:[], uncommon:[], rare:[], ultra:[], secret:[] };

  for (const c of data.data){
    const bucket = classifyRarity(c.rarity, c);
    const image = (c.images && (c.images.small || c.images.large)) || c.imageUrl || null;
    const entry = { id: c.id, name: c.name, image, raw: c };
    if (cardsByRarity[bucket]) cardsByRarity[bucket].push(entry);
    else cardsByRarity.common.push(entry);
  }

  loaded = true;
  setStatus('Base Set loaded — ready to open packs', 'green');
  openBtn.disabled = false;
  return true;
}

/* preload image (timeout) */
function preloadImage(url, timeout=4500){
  return new Promise(resolve=>{
    if (!url){ resolve(false); return; }
    const img = new Image();
    let done=false;
    const finish = ok => { if(done) return; done=true; resolve(ok) };
    img.onload = ()=> finish(true);
    img.onerror = ()=> finish(false);
    img.src = url;
    setTimeout(()=> finish(false), timeout);
  });
}

/* pick from bucket with fallback */
function pickFromBucket(bucket){
  const arr = cardsByRarity[bucket] || [];
  if (arr.length) return arr[Math.floor(Math.random()*arr.length)];
  const all = [].concat(...Object.values(cardsByRarity));
  return all.length ? all[Math.floor(Math.random()*all.length)] : null;
}

/* create revealed card DOM */
function createRevealedCard(entry, bucketKey){
  const el = document.createElement('div');
  el.className = 'revealed-card ' + (RARITY_UI[bucketKey] || '');
  const inner = document.createElement('div');
  inner.className = 'revealed-inner';
  inner.innerHTML = `
    <div class="revealed-front"><img class="card-image" src="${entry.image || CARD_BACK_DATAURI}" alt="${escapeHtml(entry.name)}"></div>
    <div class="revealed-back"><div style="margin:auto;font-weight:900;opacity:.06;font-size:44px">POKÉ</div></div>
  `;
  const label = document.createElement('div');
  label.className = 'rarity-strip ' + (RARITY_UI[bucketKey] || '');
  label.textContent = (bucketKey || 'COMMON').toUpperCase();

  const foil = document.createElement('div');
  foil.className = 'foil-overlay';
  if (bucketKey === 'ultra' || bucketKey === 'secret'){
    foil.classList.add('with-foil','foil-animate');
    foil.style.opacity = bucketKey === 'secret' ? '0.66' : '0.45';
    foil.style.animationDuration = bucketKey === 'secret' ? '1.1s' : '1.6s';
  } else { foil.style.opacity = '0'; }

  el.appendChild(inner);
  el.appendChild(foil);
  el.appendChild(label);
  return el;
}

/* escape helper */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* pack composition generator: 3 commons, 1 uncommon, 1 rare-or-better */
function generateWeightedPack(){
  if (!loaded) return null;
  const picks = [];
  for (let i=0;i<3;i++){
    const c = pickFromBucket('common');
    if (c) picks.push({entry:c, bucket:'common'});
  }
  const uc = pickFromBucket('uncommon') || pickFromBucket('common');
  if (uc) {
    const bucket = (cardsByRarity.uncommon.includes(uc)) ? 'uncommon' : 'common';
    picks.push({entry:uc, bucket});
  }
  // rare-or-better: prefer rare, then ultra, then secret, fallback to common
  let rarePick = pickFromBucket('rare') || pickFromBucket('ultra') || pickFromBucket('secret') || pickFromBucket('common');
  const rareBucket = (cardsByRarity.rare.includes(rarePick)) ? 'rare' : (cardsByRarity.ultra.includes(rarePick) ? 'ultra' : (cardsByRarity.secret.includes(rarePick) ? 'secret' : 'common'));
  if (rarePick) picks.push({entry:rarePick, bucket:rareBucket});
  return picks;
}

/* ---------------- Audio: synthesize a digital whoosh with WebAudio ----------------
   - This avoids external audio files and keeps the file self-contained.
   - Returns a Promise that resolves when the sound finishes playing.
*/
function playDigitalWhoosh(durationMs = 600){
  return new Promise(resolve=>{
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const now = ctx.currentTime;
      // white noise buffer
      const bufferSize = ctx.sampleRate * (durationMs/1000);
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++){
        // noise with slight envelope shaping
        data[i] = (Math.random()*2 - 1) * (1 - i/bufferSize) * 0.8;
      }
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;

      // sweep filter for "digital whoosh" character
      const filter = ctx.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.setValueAtTime(1200, now);
      filter.frequency.exponentialRampToValueAtTime(8000, now + durationMs/1000 * 0.7);

      // gain envelope
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.9, now + 0.06);
      gain.gain.exponentialRampToValueAtTime(0.08, now + durationMs/1000 * 0.6);
      gain.gain.exponentialRampToValueAtTime(0.001, now + durationMs/1000);

      // optional tone layer for digital sheen
      const osc = ctx.createOscillator();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(900, now);
      osc.frequency.exponentialRampToValueAtTime(2400, now + durationMs/1000 * 0.7);
      const oscGain = ctx.createGain();
      oscGain.gain.setValueAtTime(0.0, now);
      oscGain.gain.linearRampToValueAtTime(0.14, now + 0.02);
      oscGain.gain.exponentialRampToValueAtTime(0.001, now + durationMs/1000);

      // connect graph
      noise.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);

      osc.connect(oscGain);
      oscGain.connect(ctx.destination);

      noise.start(now);
      osc.start(now);
      noise.stop(now + durationMs/1000);
      osc.stop(now + durationMs/1000);

      // cleanup after sound stops
      setTimeout(()=>{
        try { ctx.close && ctx.close(); } catch(e){}
        resolve();
      }, durationMs + 30);
    } catch (e) {
      // if audio fails, just resolve silently
      resolve();
    }
  });
}

/* ---------------- Reveal pack flow ---------------- */
async function revealPack(){
  if (!loaded) return;
  if (coins < PACK_COST){ alert('Not enough coins'); return; }
  openBtn.disabled = true;

  // generate pack composition
  const picks = generateWeightedPack();
  if (!picks || !picks.length){
    setStatus('No cards available. Try again later.', 'red');
    openBtn.disabled = false;
    return;
  }

  // preload images for picks
  const preloadResults = await Promise.all(picks.map(p => preloadImage(p.entry.image)));
  for (let i=0;i<picks.length;i++){
    if (!preloadResults[i]) picks[i].entry.image = CARD_BACK_DATAURI;
  }

  // deduct coins
  coins -= PACK_COST;
  saveState();

  // clear stage and show suspense
  cardsStage.innerHTML = '';
  // short intentional suspense before whoosh
  await new Promise(r=>setTimeout(r, 180));

  // play whoosh AFTER loading message finished (we ensured loading finished earlier)
  await playDigitalWhoosh(600);

  // small pause, then reveal sequentially
  await new Promise(r=>setTimeout(r, 120));
  for (let i=0;i<picks.length;i++){
    const p = picks[i];
    const el = createRevealedCard(p.entry, p.bucket);
    el.classList.add('cardIn');
    cardsStage.appendChild(el);
    // stagger and flip
    await new Promise(r=>setTimeout(r, 260 + i*420));
    el.classList.add('flipped');

    // add to collection
    const key = `${p.entry.id || p.entry.name}|${p.bucket}`;
    collection[key] = (collection[key] || 0) + 1;
    saveState();
    renderCollection();

    // small bounce animation (non-essential)
    try { el.animate([{transform:'translateY(0)'},{transform:'translateY(-8px)'},{transform:'translateY(0)'}],{duration:420,easing:'ease-out'}); } catch(e){}
  }

  openBtn.disabled = false;
}

/* render collection in sidebar */
function renderCollection(){
  collectionGrid.innerHTML = '';
  const entries = Object.entries(collection).map(([k,v])=>{
    const [idOrName,bucket] = k.split('|');
    let image = CARD_BACK_DATAURI;
    for (const b of Object.keys(cardsByRarity)){
      const found = (cardsByRarity[b] || []).find(x => x.id === idOrName || x.name === idOrName);
      if (found){ image = found.image || CARD_BACK_DATAURI; break; }
    }
    return { idOrName, bucket: bucket || 'common', count: v, image };
  }).sort((a,b)=>{
    const order = ['secret','ultra','rare','uncommon','common'];
    if (a.bucket === b.bucket) return a.idOrName.localeCompare(b.idOrName);
    return order.indexOf(a.bucket) - order.indexOf(b.bucket);
  });

  if (!entries.length){
    collectionGrid.innerHTML = '<div class="muted">No cards yet — open packs to collect Pokémon!</div>'; 
    return;
  }
  for (const e of entries){
    const box = document.createElement('div');
    box.className = 'col-card';
    box.innerHTML = `
      <div class="col-thumb"><img src="${e.image}" alt="${escapeHtml(e.idOrName)}" style="width:100%;height:100%;object-fit:cover" /></div>
      <div style="flex:1">
        <div style="font-weight:800">${escapeHtml(e.idOrName)}</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.75)">${e.bucket} • x${e.count}</div>
      </div>
    `;
    collectionGrid.appendChild(box);
  }
}

/* ---------------- Init ---------------- */
(async function init(){
  renderCollection();
  saveState();
  // fetch Base Set via worker proxy
  await loadBaseSet();
})();

/* ---------------- UI handlers ---------------- */
openBtn.addEventListener('click', async ()=>{
  openBtn.disabled = true;
  await revealPack();
  openBtn.disabled = false;
});
resetBtn.addEventListener('click', ()=>{
  if (!confirm('Reset coins and collection?')) return;
  coins = STARTING_COINS;
  collection = {};
  localStorage.removeItem(COIN_KEY);
  localStorage.removeItem(COLLECTION_KEY);
  saveState();
  renderCollection();
  cardsStage.innerHTML = '<div id="stageHint" style="opacity:.06;font-weight:900;font-size:64px">POKÉ</div>';
});
</script>
</body>
</html>
